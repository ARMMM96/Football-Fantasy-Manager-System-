generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
      provider = "postgresql"
}


// =====================================================
// AUTHENTICATION & AUTHORIZATION
// =====================================================

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(50)
  permissions Json     @default("[]")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  isActive        Boolean   @default(true) @map("is_active")
  roleId          String    @map("role_id") @db.Uuid
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  role     Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  team     Team?
  sessions Session[]

  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash") @db.VarChar(255)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  expiresAt DateTime @map("expires_at")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

// =====================================================
// TEAM MANAGEMENT
// =====================================================

model Team {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  name         String   @db.VarChar(100)
  country      String   @default("Unknown") @db.VarChar(100)
  budget       Decimal  @default(5000000) @db.Decimal(12, 2)
  totalPlayers Int      @default(0) @map("total_players")
  isTeamReady  Boolean  @default(false) @map("is_team_ready")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  players             Player[]
  sellTransactions    TransferTransaction[] @relation("SellerTeam")
  buyTransactions     TransferTransaction[] @relation("BuyerTeam")
  financeRecords      TeamFinance[]
  transferListings    TransferListing[]

  @@index([userId])
  @@index([name])
  @@index([isTeamReady])
  @@map("teams")
}

model TeamFinance {
  id                       String   @id @default(uuid()) @db.Uuid
  teamId                   String   @map("team_id") @db.Uuid
  transactionType          String   @map("transaction_type") @db.VarChar(20)
  amount                   Decimal  @db.Decimal(12, 2)
  balanceAfter             Decimal  @map("balance_after") @db.Decimal(12, 2)
  description              String?  @db.Text
  referenceTransactionId   String?  @map("reference_transaction_id") @db.Uuid
  transactionDate          DateTime @default(now()) @map("transaction_date")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([transactionDate])
  @@index([referenceTransactionId])
  @@map("team_finance")
}

// =====================================================
// PLAYER MANAGEMENT
// =====================================================

model Player {
  id                String   @id @default(uuid()) @db.Uuid
  teamId            String   @map("team_id") @db.Uuid
  firstName         String   @map("first_name") @db.VarChar(100)
  lastName          String   @map("last_name") @db.VarChar(100)
  nationality       String   @default("Unknown") @db.VarChar(100)
  position          String   @db.VarChar(3) // GK, DEF, MID, ATT
  marketValue       Decimal  @map("market_value") @db.Decimal(12, 2)
  age               Int
  isOnTransferList  Boolean  @default(false) @map("is_on_transfer_list")
  askingPrice       Decimal? @map("asking_price") @db.Decimal(12, 2)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  team                Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  transferListing     TransferListing?
  transferTransactions TransferTransaction[]

  @@index([teamId])
  @@index([position])
  @@index([isOnTransferList])
  @@index([lastName, firstName])
  @@map("players")
}

// =====================================================
// TRANSFER SYSTEM
// =====================================================

model TransferListing {
  id           String   @id @default(uuid()) @db.Uuid
  playerId     String   @unique @map("player_id") @db.Uuid
  sellerTeamId String   @map("seller_team_id") @db.Uuid
  askingPrice  Decimal  @map("asking_price") @db.Decimal(12, 2)
  status       String   @default("ACTIVE") @db.VarChar(20)
  listedAt     DateTime @default(now()) @map("listed_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [sellerTeamId], references: [id], onDelete: Cascade)

  @@index([sellerTeamId])
  @@index([askingPrice])
  @@index([status])
  @@map("transfer_listings")
}

model TransferTransaction {
  id           String   @id @default(uuid()) @db.Uuid
  playerId     String   @map("player_id") @db.Uuid
  sellerTeamId String   @map("seller_team_id") @db.Uuid
  buyerTeamId  String   @map("buyer_team_id") @db.Uuid
  askingPrice  Decimal  @map("asking_price") @db.Decimal(12, 2)
  salePrice    Decimal  @map("sale_price") @db.Decimal(12, 2)
  commission   Decimal  @db.Decimal(12, 2)
  completedAt  DateTime @default(now()) @map("completed_at")

  player     Player @relation(fields: [playerId], references: [id], onDelete: Restrict)
  sellerTeam Team   @relation("SellerTeam", fields: [sellerTeamId], references: [id], onDelete: Restrict)
  buyerTeam  Team   @relation("BuyerTeam", fields: [buyerTeamId], references: [id], onDelete: Restrict)

  @@index([playerId])
  @@index([sellerTeamId])
  @@index([buyerTeamId])
  @@index([completedAt])
  @@map("transfer_transactions")
}

// =====================================================
// AUDIT & COMPLIANCE
// =====================================================

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  entityType  String   @map("entity_type") @db.VarChar(50)
  entityId    String   @map("entity_id") @db.Uuid
  action      String   @db.VarChar(50)
  changes     Json?
  userId      String?  @map("user_id") @db.Uuid
  performedAt DateTime @default(now()) @map("performed_at")

  @@index([entityType, entityId])
  @@index([userId])
  @@index([performedAt])
  @@index([action])
  @@map("audit_log")
}